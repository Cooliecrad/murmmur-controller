/******************************************************************************************************
		此文件为MP3(BY8001)驱动代码
******************************************************************************************************/

#include "mp3.h"
#include "usart.h"
uint8_t volume_grade=1;


///******************************************************************************************************
//功能：计算校验码（异或校验）
//参数1：指向数据数组的指针
//参数2：数据长度
//******************************************************************************************************/
//static uint8_t BY8001_CalculateChecksum(uint8_t *data, uint8_t len) 
//{
//   uint8_t checksum = 0;
//   for (uint8_t i = 0; i < len; i++) checksum ^= data[i];
//   return checksum;
//}/****************************************************************************************************/


/******************************************************************************************************
功能：通过UART发送命令到BY8001模块
参数1：指向命令数组的指针
参数2：命令数组的长度
******************************************************************************************************/
static void BY8001_SendCommand(uint8_t *cmd, uint8_t len) 
{
    HAL_UART_Transmit(&huart4,cmd,len,HAL_MAX_DELAY);
}/****************************************************************************************************/


/******************************************************************************************************
功能：发送播放命令
参数1：起始码
参数2：数据长度
参数3：播放命令
参数4：校验码
参数5：结束码
******************************************************************************************************/
void BY8001_Play(void) 
{
    uint8_t cmd[] = {BY8001_START_CODE, 0x03, BY8001_CMD_PLAY, 0x03 ^ BY8001_CMD_PLAY, BY8001_END_CODE};
    BY8001_SendCommand(cmd, sizeof(cmd));
}/****************************************************************************************************/


/******************************************************************************************************
功能：发送暂停命令
参数1：起始码
参数2：数据长度
参数3：暂停命令
参数4：校验码
参数5：结束码
******************************************************************************************************/
void BY8001_Pause(void) 
{
    uint8_t cmd[] = {BY8001_START_CODE, 0x03, BY8001_CMD_PAUSE, 0x03 ^ BY8001_CMD_PAUSE, BY8001_END_CODE};
    BY8001_SendCommand(cmd, sizeof(cmd));
}/****************************************************************************************************/


/******************************************************************************************************
功能：发送下一曲命令
参数1：起始码
参数2：数据长度
参数3：下一曲命令
参数4：校验码
参数5：结束码
******************************************************************************************************/
void BY8001_Next(void) 
{
    uint8_t cmd[] = {BY8001_START_CODE, 0x03, BY8001_CMD_NEXT, 0x03 ^ BY8001_CMD_NEXT, BY8001_END_CODE};
    BY8001_SendCommand(cmd, sizeof(cmd));
}/****************************************************************************************************/


/******************************************************************************************************
功能：发送上一曲命令
参数1：起始码
参数2：数据长度
参数3：上一曲命令
参数4：校验码
参数5：结束码
******************************************************************************************************/
void BY8001_Prev(void) 
{
    uint8_t cmd[] = {BY8001_START_CODE, 0x03, BY8001_CMD_PREV, 0x03 ^ BY8001_CMD_PREV, BY8001_END_CODE};
    BY8001_SendCommand(cmd, sizeof(cmd));
}/****************************************************************************************************/


/******************************************************************************************************
功能：发送停止命令
参数1：起始码
参数2：数据长度
参数3：停止命令
参数4：校验码
参数5：结束码
******************************************************************************************************/
void BY8001_Stop(void) 
{
    uint8_t cmd[] = {BY8001_START_CODE, 0x03, BY8001_CMD_STOP, 0x03 ^ BY8001_CMD_STOP, BY8001_END_CODE};
    BY8001_SendCommand(cmd, sizeof(cmd));
}/****************************************************************************************************/


/******************************************************************************************************
功能：设置音量（范围为0-30）
参数1：起始码
参数2：数据长度
参数3：设置音量命令
参数4：音量值
参数5：校验码
参数6：结束码
******************************************************************************************************/
void BY8001_SetVolume(uint8_t volume) 
{
    if (volume > 30) volume = 30;  // 音量最大为30
    uint8_t cmd[] = {BY8001_START_CODE, 0x04, BY8001_CMD_SET_VOLUME, volume,
										 0x04 ^ BY8001_CMD_SET_VOLUME ^ volume, BY8001_END_CODE};
    BY8001_SendCommand(cmd, sizeof(cmd));
}/****************************************************************************************************/


/******************************************************************************************************
功能：播放指定曲目（曲目编号范围为1-65536）
参数1：起始码
参数2：数据长度
参数3：播放指定曲目命令
参数4：曲目编号的高字节
参数5：曲目编号的低字节
参数6：校验码
参数7：结束码
******************************************************************************************************/
void BY8001_PlayTrack(uint16_t track) 
{
    uint8_t highByte = (track >> 8) & 0xFF;
    uint8_t lowByte = track & 0xFF;
    uint8_t checksum = 0x05 ^ BY8001_CMD_PLAY_TRACK ^ highByte ^ lowByte;
    uint8_t cmd[] = {BY8001_START_CODE, 0x05, BY8001_CMD_PLAY_TRACK, highByte, lowByte, checksum,
										 BY8001_END_CODE};
    BY8001_SendCommand(cmd, sizeof(cmd));
}/****************************************************************************************************/

/******************************************************************************************************
功能：发送循环模式命令
参数1：起始码
参数2：数据长度
参数3：循环命令
参数4：循环指令 0-4(全盘/文件夹/单曲/随机/无循环)
参数4：校验码
参数5：结束码
******************************************************************************************************/
void BY8001_Loop(uint8_t mood) 
{
    uint8_t cmd[] = {BY8001_START_CODE, 0x04, BY8001_CMD_SET_LOOP_MODE,mood,
		0x04 ^BY8001_CMD_SET_LOOP_MODE^ mood, BY8001_END_CODE};
    BY8001_SendCommand(cmd, sizeof(cmd));
}/****************************************************************************************************/

